/* SponsorAds Embed Script */
!function(){"use strict";const e={apiBaseUrl:"http://localhost:8000/api",placementClass:"sponsor-ad",placementAttribute:"data-placement",loadedAttribute:"data-sponsor-loaded",retryAttempts:3,retryDelay:1e3};let t=new Set,n=new Set,o=[],s=null;async function a(t,n=1){try{const n=await fetch(`${e.apiBaseUrl}/placements/banners`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({placements:t})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return(await n.json()).banners||{}}catch(o){return console.error(`[SponsorAds] Failed to fetch banners (attempt ${n}):`,o),n<e.retryAttempts?(await new Promise(t=>setTimeout(t,e.retryDelay*n)),a(t,n+1)):{}}}async function r(){if(0===o.length)return;const e=[...o];o=[],s=null,console.log("[SponsorAds] Impression tracking disabled (would have tracked:",e.length,")")}function i(e){t.has(e)||(t.add(e),o.push(e),s&&clearTimeout(s),s=setTimeout(r,500))}function c(e){const t=document.createElement("div");t.className="sponsor-ad-banner",t.style.cssText="width: 100%; height: auto;";const o=document.createElement("a");o.href=e.target_url,o.target="_blank",o.rel="noopener noreferrer sponsored",o.style.cssText="display: block; text-decoration: none;",o.setAttribute("data-sponsor-uuid",e.uuid);const s=document.createElement("img");if(s.src=e.image_url,s.alt=e.title,s.style.cssText="width: 100%; height: auto; display: block;",s.loading="lazy",o.appendChild(s),e.link_text){const t=document.createElement("div");t.textContent=e.link_text,t.style.cssText="margin-top: 8px; text-align: center; font-size: 14px; color: #666;",o.appendChild(t)}return o.addEventListener("click",function(t){!async function(e){n.has(e)||(n.add(e),console.log("[SponsorAds] Click tracking disabled"))}(e.uuid)}),t.appendChild(o),t}function l(t,n){t.setAttribute(e.loadedAttribute,"true"),t.classList.remove("loading"),t.innerHTML="";const o=c(n);t.appendChild(o),function(e,t){if("IntersectionObserver"in window){const n=new IntersectionObserver(o=>{o.forEach(o=>{o.isIntersecting&&(i(t),n.unobserve(e))})},{threshold:.5});n.observe(e)}else i(t)}(t,n.uuid)}async function d(){const{placements:t,placementMap:n}=function(){const t=document.querySelectorAll(`.${e.placementClass}[${e.placementAttribute}]:not([${e.loadedAttribute}])`),n=[],o=new Map;return t.forEach(t=>{const s=t.getAttribute(e.placementAttribute);s&&(n.push(s),o.has(s)||o.set(s,[]),o.set(s,[...o.get(s),t]))}),{placements:[...new Set(n)],placementMap:o}}();if(0===t.length)return;console.log("[SponsorAds] Found placements:",t);const o=await a(t);console.log("[SponsorAds] Loaded banners:",o),n.forEach((t,n)=>{const s=o[n];s?t.forEach(e=>{l(e,s)}):(console.warn(`[SponsorAds] No banner found for placement: ${n}`),t.forEach(t=>{t.setAttribute(e.loadedAttribute,"true"),t.classList.remove("loading")}))})}!function(){if("loading"===document.readyState?document.addEventListener("DOMContentLoaded",d):d(),"MutationObserver"in window){let e;new MutationObserver(()=>{e&&clearTimeout(e),e=setTimeout(d,100)}).observe(document.body,{childList:!0,subtree:!0})}}(),window.SponsorAds={reload:d,config:e}}();